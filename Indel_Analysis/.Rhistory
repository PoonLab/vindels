# @param outcomes:  vector of boolean values, TRUE if *no* indel on cherry
# @param times:  vector of branch lengths associated with cherries
# @return: log-likelihood of model
pr <- exp(-rate * times)  # probabilities of no indels for each cherry
sum( outcomes * log(pr), (1-outcomes) * log(1-pr) )
}
csvfolder <- list.files(path="~/PycharmProjects/hiv-evolution-master/9_2_indels",full.names=TRUE)
max.llh <- data.frame(stringsAsFactors = FALSE)
max.llh2 <- data.frame(subtype=character(),stringsAsFactors = FALSE)
con.int <- data.frame(stringsAsFactors = FALSE)
big.df <- data.frame(stringsAsFactors = FALSE)
rates <- c()
for (i in 1:length(csvfolder)){
csv <- read.csv(csvfolder[i])
filename <- strsplit(strsplit(csvfolder[i], "/")[[1]][7], "\\+.")[[1]][1]
max.llh2 [i,1] <- filename
print(filename)
times.df <- c()
outcomes.df <- data.frame()
for (z in 1:5){
times <- csv$total.length[which(!is.na(csv[paste0("VR",z,".indel")]))]
times.df <- c(times.df, times)
outcomes <- csv[which(!is.na(csv[paste0("VR",z,".indel")])),paste0("VR",z,".indel")]
outcomes.df <- rbind(outcomes.df, data.frame(out=outcomes, vregion=z))
obj.f <- function(rate) -pll(rate, outcomes, times)  # objective function
mle.result <- bbmle::mle2(obj.f, start=list(rate=1), method = "Brent", lower=1e-12, upper = 1)
max.llh <- rbind(max.llh, data.frame(subtype=filename, vloop=z, rate=coef(mle.result)[[1]]))
max.llh2 [i,z+1] <- coef(mle.result)[[1]]
rates <- c(rates,coef(mle.result)[[1]]) # this is the rate
#res$value #this is the likelihood
if(!all(outcomes)){
int <- confint(mle.result, level = 0.95)
con.int <- rbind(con.int,data.frame(subtype=filename,vloop=z,lower=int[[1]],upper=int[[2]]))
}else{
con.int <- rbind(con.int,data.frame(subtype=filename,vloop=z,lower=0,upper=0))
}
}
big.df <- rbind(big.df, data.frame(subtype=rep(filename, length(times.df)), Time=times.df, outcomes=outcomes.df$out, Vregion=as.factor(outcomes.df$vregion)))
}
setwd("~/vindels/Indel_Analysis/")
require(bbmle)
require(MASS)
obj.f <- function(rate) -pll(rate, outcomes, times)  # objective function
pll <- function(rate, outcomes, times) {
# @param rate:  instantaneous rate of indels
# @param outcomes:  vector of boolean values, TRUE if *no* indel on cherry
# @param times:  vector of branch lengths associated with cherries
# @return: log-likelihood of model
pr <- exp(-rate * times)  # probabilities of no indels for each cherry
sum( outcomes * log(pr), (1-outcomes) * log(1-pr) )
}
csvfolder <- list.files(path="~/PycharmProjects/hiv-evolution-master/9_2_indels",full.names=TRUE)
max.llh <- data.frame(stringsAsFactors = FALSE)
max.llh2 <- data.frame(subtype=character(),stringsAsFactors = FALSE)
con.int <- data.frame(stringsAsFactors = FALSE)
big.df <- data.frame(stringsAsFactors = FALSE)
rates <- c()
for (i in 1:length(csvfolder)){
csv <- read.csv(csvfolder[i])
filename <- strsplit(strsplit(csvfolder[i], "/")[[1]][7], "\\+.")[[1]][1]
max.llh2 [i,1] <- filename
print(filename)
times.df <- c()
outcomes.df <- data.frame()
for (z in 1:5){
times <- csv$total.length[which(!is.na(csv[paste0("VR",z,".indel")]))]
times.df <- c(times.df, times)
outcomes <- csv[which(!is.na(csv[paste0("VR",z,".indel")])),paste0("VR",z,".indel")]
outcomes.df <- rbind(outcomes.df, data.frame(out=outcomes, vregion=z))
obj.f <- function(rate) -pll(rate, outcomes, times)  # objective function
mle.result <- bbmle::mle2(obj.f, start=list(rate=1), method = "Brent", lower=1e-12, upper = 1)
max.llh <- rbind(max.llh, data.frame(subtype=filename, vloop=z, rate=coef(mle.result)[[1]]))
max.llh2 [i,z+1] <- coef(mle.result)[[1]]
rates <- c(rates,coef(mle.result)[[1]]) # this is the rate
#res$value #this is the likelihood
if(!all(outcomes)){
int <- confint(mle.result, level = 0.95)
con.int <- rbind(con.int,data.frame(subtype=filename,vloop=z,lower=int[[1]],upper=int[[2]]))
}else{
con.int <- rbind(con.int,data.frame(subtype=filename,vloop=z,lower=0,upper=0))
}
}
big.df <- rbind(big.df, data.frame(subtype=rep(filename, length(times.df)), Time=times.df, outcomes=outcomes.df$out, Vregion=as.factor(outcomes.df$vregion)))
}
rates <- split(max.llh[,2:3], max.llh[,1])
rates
require(ggplot2)
#indel rate plot
require(RColorBrewer)
colors <- brewer.pal(7, 'Set2')
con.int <- con.int[order(con.int$vloop),]
barplot(max.llh$rate)
plot <- ggplot(max.llh, aes(x=vloop, y=rates, fill=subtype,width=1)) + geom_bar(colour="black",stat="identity", position="dodge", show.legend=F) + facet_wrap(~subtype,ncol=7,nrow=1)
plot + labs(x="Variable Loop",
y="Indel Rate (Events/Year)")+scale_fill_manual(values=
colors)+scale_y_continuous(expand = c(0, 0),
limits = c(0, 0.155))+theme(panel.grid.major = element_blank(),
panel.grid.minor.y = element_line(color="black"),
plot.margin =margin(t = 10, r = 10, b = 20, l = 20, unit = "pt"),
axis.line = element_line(colour = "black"),
axis.title.y=element_text(size=18,margin=margin(t = 0, r = 15, b = 0, l = 0)),
axis.title.x=element_text(size=18,margin=margin(t = 15, r = 0, b = 0, l = 0)),
strip.text.x = element_text(size=12),
axis.text=element_text(size=12))+ geom_errorbar(aes(ymax = con.int$upper,
ymin = con.int$lower),
width = 0.25)
plot <- ggplot(max.llh, aes(x=vloop, y=rates, fill=subtype,width=1)) + geom_bar(colour="black",stat="identity", position="dodge", show.legend=F) + facet_wrap(~subtype,ncol=7,nrow=1)
plot + labs(x="Variable Loop",
y="Indel Rate (Events/Year)")+scale_fill_manual(values=
colors)+scale_y_continuous(expand = c(0, 0),
limits = c(0, 0.155))+theme(panel.grid.major = element_blank(),
panel.grid.minor.y = element_line(color="black"),
plot.margin =margin(t = 10, r = 10, b = 20, l = 20, unit = "pt"),
axis.line = element_line(colour = "black"),
axis.title.y=element_text(size=18,margin=margin(t = 0, r = 15, b = 0, l = 0)),
axis.title.x=element_text(size=18,margin=margin(t = 15, r = 0, b = 0, l = 0)),
strip.text.x = element_text(size=12),
axis.text=element_text(size=12))+ geom_errorbar(aes(ymax = con.int$upper,
ymin = con.int$lower),
width = 0.25)
plot <- ggplot(max.llh, aes(x=vloop, y=rates, fill=colors,width=1)) + geom_bar(colour="black",stat="identity", position="dodge", show.legend=F) + facet_wrap(~subtype,ncol=7,nrow=1)
plot + labs(x="Variable Loop",
y="Indel Rate (Events/Year)")+scale_fill_manual(values=
colors)+scale_y_continuous(expand = c(0, 0),
limits = c(0, 0.155))+theme(panel.grid.major = element_blank(),
panel.grid.minor.y = element_line(color="black"),
plot.margin =margin(t = 10, r = 10, b = 20, l = 20, unit = "pt"),
axis.line = element_line(colour = "black"),
axis.title.y=element_text(size=18,margin=margin(t = 0, r = 15, b = 0, l = 0)),
axis.title.x=element_text(size=18,margin=margin(t = 15, r = 0, b = 0, l = 0)),
strip.text.x = element_text(size=12),
axis.text=element_text(size=12))+ geom_errorbar(aes(ymax = con.int$upper,
ymin = con.int$lower),
width = 0.25)
for (z in 1:5){
times <- csv$total.length[which(!is.na(csv[paste0("VR",z,".indel")]))]
times.df <- c(times.df, times)
outcomes <- csv[which(!is.na(csv[paste0("VR",z,".indel")])),paste0("VR",z,".indel")]
outcomes.df <- rbind(outcomes.df, data.frame(out=outcomes, vregion=z))
obj.f <- function(rate) -pll(rate, outcomes, times)  # objective function
mle.result <- bbmle::mle2(obj.f, start=list(rate=1), method = "Brent", lower=1e-12, upper = 1)
max.llh <- rbind(max.llh, data.frame(subtype=filename, vloop=z, rate=coef(mle.result)[[1]]))
max.llh2 [i,z+1] <- coef(mle.result)[[1]]
rates <- c(rates,coef(mle.result)[[1]]) # this is the rate
#res$value #this is the likelihood
if(!all(outcomes)){
int <- confint(mle.result, level = 0.95)
con.int <- rbind(con.int,data.frame(subtype=filename,vloop=z,lower=int[[1]],upper=int[[2]]))
}else{
con.int <- rbind(con.int,data.frame(subtype=filename,vloop=z,lower=0,upper=0))
}
}
colors <- rep(brewer.pal(7, 'Set2'),5)
plot <- ggplot(max.llh, aes(x=vloop, y=rates, fill=colors,width=1)) + geom_bar(colour="black",stat="identity", position="dodge", show.legend=F) + facet_wrap(~subtype,ncol=7,nrow=1)
plot + labs(x="Variable Loop",
y="Indel Rate (Events/Year)")+scale_fill_manual(values=
colors)+scale_y_continuous(expand = c(0, 0),
limits = c(0, 0.155))+theme(panel.grid.major = element_blank(),
panel.grid.minor.y = element_line(color="black"),
plot.margin =margin(t = 10, r = 10, b = 20, l = 20, unit = "pt"),
axis.line = element_line(colour = "black"),
axis.title.y=element_text(size=18,margin=margin(t = 0, r = 15, b = 0, l = 0)),
axis.title.x=element_text(size=18,margin=margin(t = 15, r = 0, b = 0, l = 0)),
strip.text.x = element_text(size=12),
axis.text=element_text(size=12))+ geom_errorbar(aes(ymax = con.int$upper,
ymin = con.int$lower),
width = 0.25)
colors
plot <- ggplot(max.llh, aes(x=vloop, y=rates, fill=subtype,width=1)) + geom_bar(colour="black",stat="identity", position="dodge", show.legend=F) + facet_wrap(~subtype,ncol=7,nrow=1)
plot + labs(x="Variable Loop",
y="Indel Rate (Events/Year)")+scale_fill_manual(values=
colors)+scale_y_continuous(expand = c(0, 0),
limits = c(0, 0.155))+theme(panel.grid.major = element_blank(),
panel.grid.minor.y = element_line(color="black"),
plot.margin =margin(t = 10, r = 10, b = 20, l = 20, unit = "pt"),
axis.line = element_line(colour = "black"),
axis.title.y=element_text(size=18,margin=margin(t = 0, r = 15, b = 0, l = 0)),
axis.title.x=element_text(size=18,margin=margin(t = 15, r = 0, b = 0, l = 0)),
strip.text.x = element_text(size=12),
axis.text=element_text(size=12))+ geom_errorbar(aes(ymax = con.int$upper,
ymin = con.int$lower),
width = 0.25)
require(ggplot2)
#indel rate plot
require(RColorBrewer)
colors <- rep(brewer.pal(7, 'Set2'),5)
con.int <- con.int[order(con.int$vloop),]
barplot(max.llh$rate)
rates <- split(max.llh[,2:3], max.llh[,1])
#plot <- ggplot(data=max.llh)
require(ggplot2)
#indel rate plot
require(RColorBrewer)
colors <- rep(brewer.pal(7, 'Set2'),5)
con.int <- con.int[order(con.int$vloop),]
rates <- split(max.llh[,2:3], max.llh[,1])
plot <- ggplot(max.llh, aes(x=vloop, y=rates, fill=subtype,width=1)) + geom_bar(colour="black",stat="identity", position="dodge", show.legend=F) + facet_wrap(~subtype,ncol=7,nrow=1)
plot + labs(x="Variable Loop",
y="Indel Rate (Events/Year)")+scale_fill_manual(values=
colors)+scale_y_continuous(expand = c(0, 0),
limits = c(0, 0.155))+theme(panel.grid.major = element_blank(),
panel.grid.minor.y = element_line(color="black"),
plot.margin =margin(t = 10, r = 10, b = 20, l = 20, unit = "pt"),
axis.line = element_line(colour = "black"),
axis.title.y=element_text(size=18,margin=margin(t = 0, r = 15, b = 0, l = 0)),
axis.title.x=element_text(size=18,margin=margin(t = 15, r = 0, b = 0, l = 0)),
strip.text.x = element_text(size=12),
axis.text=element_text(size=12))+ geom_errorbar(aes(ymax = con.int$upper,
ymin = con.int$lower),
width = 0.25)
rates
max.llh
setwd("~/vindels/Indel_Analysis/")
require(bbmle)
require(MASS)
obj.f <- function(rate) -pll(rate, outcomes, times)  # objective function
pll <- function(rate, outcomes, times) {
# @param rate:  instantaneous rate of indels
# @param outcomes:  vector of boolean values, TRUE if *no* indel on cherry
# @param times:  vector of branch lengths associated with cherries
# @return: log-likelihood of model
pr <- exp(-rate * times)  # probabilities of no indels for each cherry
sum( outcomes * log(pr), (1-outcomes) * log(1-pr) )
}
csvfolder <- list.files(path="~/PycharmProjects/hiv-evolution-master/9_2_indels",full.names=TRUE)
max.llh <- data.frame(stringsAsFactors = FALSE)
max.llh2 <- data.frame(subtype=character(),stringsAsFactors = FALSE)
con.int <- data.frame(stringsAsFactors = FALSE)
big.df <- data.frame(stringsAsFactors = FALSE)
rates <- c()
for (i in 1:length(csvfolder)){
csv <- read.csv(csvfolder[i])
filename <- strsplit(strsplit(csvfolder[i], "/")[[1]][7], "\\+.")[[1]][1]
max.llh2 [i,1] <- filename
print(filename)
times.df <- c()
outcomes.df <- data.frame()
for (z in 1:5){
times <- csv$total.length[which(!is.na(csv[paste0("VR",z,".indel")]))]
times.df <- c(times.df, times)
outcomes <- csv[which(!is.na(csv[paste0("VR",z,".indel")])),paste0("VR",z,".indel")]
outcomes.df <- rbind(outcomes.df, data.frame(out=outcomes, vregion=z))
obj.f <- function(rate) -pll(rate, outcomes, times)  # objective function
mle.result <- bbmle::mle2(obj.f, start=list(rate=1), method = "Brent", lower=1e-12, upper = 1)
max.llh <- rbind(max.llh, data.frame(subtype=filename, vloop=z, rate=coef(mle.result)[[1]]))
max.llh2 [i,z+1] <- coef(mle.result)[[1]]
rates <- c(rates,coef(mle.result)[[1]]) # this is the rate
#res$value #this is the likelihood
if(!all(outcomes)){
int <- confint(mle.result, level = 0.95)
con.int <- rbind(con.int,data.frame(subtype=filename,vloop=z,lower=int[[1]],upper=int[[2]]))
}else{
con.int <- rbind(con.int,data.frame(subtype=filename,vloop=z,lower=0,upper=0))
}
}
big.df <- rbind(big.df, data.frame(subtype=rep(filename, length(times.df)), Time=times.df, outcomes=outcomes.df$out, Vregion=as.factor(outcomes.df$vregion)))
}
equire(ggplot2)
#indel rate plot
require(RColorBrewer)
colors <- rep(brewer.pal(7, 'Set2'),5)
con.int <- con.int[order(con.int$vloop),]
rates <- split(max.llh[,2:3], max.llh[,1])
#plot <- ggplot(data=max.llh)
plot <- ggplot(max.llh, aes(x=vloop, y=rates, fill=subtype,width=1)) + geom_bar(colour="black",stat="identity", position="dodge", show.legend=F) + facet_wrap(~subtype,ncol=7,nrow=1)
plot + labs(x="Variable Loop",
y="Indel Rate (Events/Year)")+scale_fill_manual(values=
colors)+scale_y_continuous(expand = c(0, 0),
limits = c(0, 0.155))+theme(panel.grid.major = element_blank(),
panel.grid.minor.y = element_line(color="black"),
plot.margin =margin(t = 10, r = 10, b = 20, l = 20, unit = "pt"),
axis.line = element_line(colour = "black"),
axis.title.y=element_text(size=18,margin=margin(t = 0, r = 15, b = 0, l = 0)),
axis.title.x=element_text(size=18,margin=margin(t = 15, r = 0, b = 0, l = 0)),
strip.text.x = element_text(size=12),
axis.text=element_text(size=12))+ geom_errorbar(aes(ymax = con.int$upper,
ymin = con.int$lower),
width = 0.25)
plot <- ggplot(max.llh, aes(x=vloop, y=rates, fill=colors,width=1)) + geom_bar(colour="black",stat="identity", position="dodge", show.legend=F) + facet_wrap(~subtype,ncol=7,nrow=1)
plot + labs(x="Variable Loop",
y="Indel Rate (Events/Year)")+scale_fill_manual(values=
colors)+scale_y_continuous(expand = c(0, 0),
limits = c(0, 0.155))+theme(panel.grid.major = element_blank(),
panel.grid.minor.y = element_line(color="black"),
plot.margin =margin(t = 10, r = 10, b = 20, l = 20, unit = "pt"),
axis.line = element_line(colour = "black"),
axis.title.y=element_text(size=18,margin=margin(t = 0, r = 15, b = 0, l = 0)),
axis.title.x=element_text(size=18,margin=margin(t = 15, r = 0, b = 0, l = 0)),
strip.text.x = element_text(size=12),
axis.text=element_text(size=12))+ geom_errorbar(aes(ymax = con.int$upper,
ymin = con.int$lower),
width = 0.25)
plot <- ggplot(max.llh, aes(x=vloop, y=rates, fill=colors,width=1)) + geom_bar(colour="black",stat="identity", position="dodge", show.legend=F) + facet_wrap(~subtype,ncol=7,nrow=1)
plot + labs(x="Variable Loop",
y="Indel Rate (Events/Year)")+scale_fill_manual(values=
colors)+scale_y_continuous(expand = c(0, 0),
limits = c(0, 0.155))+theme(panel.grid.major = element_blank(),
panel.grid.minor.y = element_line(color="black"),
plot.margin =margin(t = 10, r = 10, b = 20, l = 20, unit = "pt"),
axis.line = element_line(colour = "black"),
axis.title.y=element_text(size=18,margin=margin(t = 0, r = 15, b = 0, l = 0)),
axis.title.x=element_text(size=18,margin=margin(t = 15, r = 0, b = 0, l = 0)),
strip.text.x = element_text(size=12),
axis.text=element_text(size=12))+ geom_errorbar(aes(ymax = con.int$upper,
ymin = con.int$lower),
width = 0.25)
colors <- brewer.pal(7, 'Set2')
con.int <- con.int[order(con.int$vloop),]
rates <- split(max.llh[,2:3], max.llh[,1])
plot <- ggplot(max.llh, aes(x=vloop, y=rates, fill=subtypes,width=1)) + geom_bar(colour="black",stat="identity", position="dodge", show.legend=F) + facet_wrap(~subtype,ncol=7,nrow=1)
plot + labs(x="Variable Loop",
y="Indel Rate (Events/Year)")+scale_fill_manual(values=
colors)+scale_y_continuous(expand = c(0, 0),
limits = c(0, 0.155))+theme(panel.grid.major = element_blank(),
panel.grid.minor.y = element_line(color="black"),
plot.margin =margin(t = 10, r = 10, b = 20, l = 20, unit = "pt"),
axis.line = element_line(colour = "black"),
axis.title.y=element_text(size=18,margin=margin(t = 0, r = 15, b = 0, l = 0)),
axis.title.x=element_text(size=18,margin=margin(t = 15, r = 0, b = 0, l = 0)),
strip.text.x = element_text(size=12),
axis.text=element_text(size=12))+ geom_errorbar(aes(ymax = con.int$upper,
ymin = con.int$lower),
width = 0.25)
plot <- ggplot(max.llh, aes(x=vloop, y=rates, fill=subtype,width=1)) + geom_bar(colour="black",stat="identity", position="dodge", show.legend=F) + facet_wrap(~subtype,ncol=7,nrow=1)
plot + labs(x="Variable Loop",
y="Indel Rate (Events/Year)")+scale_fill_manual(values=
colors)+scale_y_continuous(expand = c(0, 0),
limits = c(0, 0.155))+theme(panel.grid.major = element_blank(),
panel.grid.minor.y = element_line(color="black"),
plot.margin =margin(t = 10, r = 10, b = 20, l = 20, unit = "pt"),
axis.line = element_line(colour = "black"),
axis.title.y=element_text(size=18,margin=margin(t = 0, r = 15, b = 0, l = 0)),
axis.title.x=element_text(size=18,margin=margin(t = 15, r = 0, b = 0, l = 0)),
strip.text.x = element_text(size=12),
axis.text=element_text(size=12))+ geom_errorbar(aes(ymax = con.int$upper,
ymin = con.int$lower),
width = 0.25)
vloop
max.llh
rates
max.llh
plot <- ggplot(max.llh, aes(x=vloop, y=rate, fill=subtype,width=1)) + geom_bar(colour="black",stat="identity", position="dodge", show.legend=F) + facet_wrap(~subtype,ncol=7,nrow=1)
plot + labs(x="Variable Loop",
y="Indel Rate (Events/Year)")+scale_fill_manual(values=
colors)+scale_y_continuous(expand = c(0, 0),
limits = c(0, 0.155))+theme(panel.grid.major = element_blank(),
panel.grid.minor.y = element_line(color="black"),
plot.margin =margin(t = 10, r = 10, b = 20, l = 20, unit = "pt"),
axis.line = element_line(colour = "black"),
axis.title.y=element_text(size=18,margin=margin(t = 0, r = 15, b = 0, l = 0)),
axis.title.x=element_text(size=18,margin=margin(t = 15, r = 0, b = 0, l = 0)),
strip.text.x = element_text(size=12),
axis.text=element_text(size=12))+ geom_errorbar(aes(ymax = con.int$upper,
ymin = con.int$lower),
width = 0.25)
colors
rates
plot <- ggplot(rates, aes(x=vloop, y=rate, fill=subtype,width=1)) + geom_bar(colour="black",stat="identity", position="dodge", show.legend=F) + facet_wrap(~subtype,ncol=7,nrow=1)
plot + labs(x="Variable Loop",
y="Indel Rate (Events/Year)")+scale_fill_manual(values=
colors)+scale_y_continuous(expand = c(0, 0),
limits = c(0, 0.155))+theme(panel.grid.major = element_blank(),
panel.grid.minor.y = element_line(color="black"),
plot.margin =margin(t = 10, r = 10, b = 20, l = 20, unit = "pt"),
axis.line = element_line(colour = "black"),
axis.title.y=element_text(size=18,margin=margin(t = 0, r = 15, b = 0, l = 0)),
axis.title.x=element_text(size=18,margin=margin(t = 15, r = 0, b = 0, l = 0)),
strip.text.x = element_text(size=12),
axis.text=element_text(size=12))+ geom_errorbar(aes(ymax = con.int$upper,
ymin = con.int$lower),
width = 0.25)
plot <- ggplot(max.llh, aes(x=vloop, y=rates, fill=subtype,width=1)) + geom_bar(colour="black",stat="identity", position="dodge", show.legend=F) + facet_wrap(~subtype,ncol=7,nrow=1)
plot + labs(x="Variable Loop",
y="Indel Rate (Events/Year)")+scale_fill_manual(values=
colors)+scale_y_continuous(expand = c(0, 0),
limits = c(0, 0.155))+theme(panel.grid.major = element_blank(),
panel.grid.minor.y = element_line(color="black"),
plot.margin =margin(t = 10, r = 10, b = 20, l = 20, unit = "pt"),
axis.line = element_line(colour = "black"),
axis.title.y=element_text(size=18,margin=margin(t = 0, r = 15, b = 0, l = 0)),
axis.title.x=element_text(size=18,margin=margin(t = 15, r = 0, b = 0, l = 0)),
strip.text.x = element_text(size=12),
axis.text=element_text(size=12))+ geom_errorbar(aes(ymax = con.int$upper,
ymin = con.int$lower),
width = 0.25)
plot <- ggplot(max.llh, aes(x=vloop, y=rates, fill=rep(colors,5),width=1)) + geom_bar(colour="black",stat="identity", position="dodge", show.legend=F) + facet_wrap(~subtype,ncol=7,nrow=1)
plot + labs(x="Variable Loop",
y="Indel Rate (Events/Year)")+scale_fill_manual(values=
colors)+scale_y_continuous(expand = c(0, 0),
limits = c(0, 0.155))+theme(panel.grid.major = element_blank(),
panel.grid.minor.y = element_line(color="black"),
plot.margin =margin(t = 10, r = 10, b = 20, l = 20, unit = "pt"),
axis.line = element_line(colour = "black"),
axis.title.y=element_text(size=18,margin=margin(t = 0, r = 15, b = 0, l = 0)),
axis.title.x=element_text(size=18,margin=margin(t = 15, r = 0, b = 0, l = 0)),
strip.text.x = element_text(size=12),
axis.text=element_text(size=12))+ geom_errorbar(aes(ymax = con.int$upper,
ymin = con.int$lower),
width = 0.25)
plot <- ggplot(max.llh, aes(x=vloop, y=rates, fill=rep(colors,5),width=1)) + geom_bar(colour="black",stat="identity", position="dodge", show.legend=F) + facet_wrap(~subtype,ncol=7,nrow=1)
plot + labs(x="Variable Loop",
y="Indel Rate (Events/Year)")+scale_y_continuous(expand = c(0, 0),
limits = c(0, 0.155))+theme(panel.grid.major = element_blank(),
panel.grid.minor.y = element_line(color="black"),
plot.margin =margin(t = 10, r = 10, b = 20, l = 20, unit = "pt"),
axis.line = element_line(colour = "black"),
axis.title.y=element_text(size=18,margin=margin(t = 0, r = 15, b = 0, l = 0)),
axis.title.x=element_text(size=18,margin=margin(t = 15, r = 0, b = 0, l = 0)),
strip.text.x = element_text(size=12),
axis.text=element_text(size=12))+ geom_errorbar(aes(ymax = con.int$upper,
ymin = con.int$lower),
width = 0.25)
plot <- ggplot(max.llh, aes(x=vloop, y=rates, fill=colors)) + geom_bar(colour="black",stat="identity", position="dodge", show.legend=F) + facet_wrap(~subtype,ncol=7,nrow=1)
plot + labs(x="Variable Loop",
y="Indel Rate (Events/Year)")+scale_fill_manual(values=
colors)+scale_y_continuous(expand = c(0, 0),
limits = c(0, 0.155))+theme(panel.grid.major = element_blank(),
panel.grid.minor.y = element_line(color="black"),
plot.margin =margin(t = 10, r = 10, b = 20, l = 20, unit = "pt"),
axis.line = element_line(colour = "black"),
axis.title.y=element_text(size=18,margin=margin(t = 0, r = 15, b = 0, l = 0)),
axis.title.x=element_text(size=18,margin=margin(t = 15, r = 0, b = 0, l = 0)),
strip.text.x = element_text(size=12),
axis.text=element_text(size=12))+ geom_errorbar(aes(ymax = con.int$upper,
ymin = con.int$lower),
width = 0.25)
max.llh
plot <- ggplot(max.llh, aes(x=vloop, y=rate, fill=subtype)) + geom_bar(colour="black",stat="identity", position="dodge", show.legend=F) + facet_wrap(~subtype,ncol=7,nrow=1)
plot + labs(x="Variable Loop",
y="Indel Rate (Events/Year)")+scale_fill_manual(values=
colors)+scale_y_continuous(expand = c(0, 0),
limits = c(0, 0.155))+theme(panel.grid.major = element_blank(),
panel.grid.minor.y = element_line(color="black"),
plot.margin =margin(t = 10, r = 10, b = 20, l = 20, unit = "pt"),
axis.line = element_line(colour = "black"),
axis.title.y=element_text(size=18,margin=margin(t = 0, r = 15, b = 0, l = 0)),
axis.title.x=element_text(size=18,margin=margin(t = 15, r = 0, b = 0, l = 0)),
strip.text.x = element_text(size=12),
axis.text=element_text(size=12))+ geom_errorbar(aes(ymax = con.int$upper,
ymin = con.int$lower),
width = 0.25)
con.int
con.int <- con.int[order(con.int$subtype),]
con.int
rates <- split(max.llh[,2:3], max.llh[,1])
plot <- ggplot(max.llh, aes(x=vloop, y=rate, fill=subtype, width=1)) + geom_bar(colour="black",stat="identity", position="dodge", show.legend=F) + facet_wrap(~subtype,ncol=7,nrow=1)
plot + labs(x="Variable Loop",
y="Indel Rate (Events/Year)")+scale_fill_manual(values=
colors)+scale_y_continuous(expand = c(0, 0),
limits = c(0, 0.155))+theme(panel.grid.major = element_blank(),
panel.grid.minor.y = element_line(color="black"),
plot.margin =margin(t = 10, r = 10, b = 20, l = 20, unit = "pt"),
axis.line = element_line(colour = "black"),
axis.title.y=element_text(size=18,margin=margin(t = 0, r = 15, b = 0, l = 0)),
axis.title.x=element_text(size=18,margin=margin(t = 15, r = 0, b = 0, l = 0)),
strip.text.x = element_text(size=12),
axis.text=element_text(size=12))+ geom_errorbar(aes(ymax = con.int$upper,
ymin = con.int$lower),
width = 0.25)
setwd("~/vindels/Indel_Analysis/")
require(bbmle)
require(MASS)
obj.f <- function(rate) -pll(rate, outcomes, times)  # objective function
pll <- function(rate, outcomes, times) {
# @param rate:  instantaneous rate of indels
# @param outcomes:  vector of boolean values, TRUE if *no* indel on cherry
# @param times:  vector of branch lengths associated with cherries
# @return: log-likelihood of model
pr <- exp(-rate * times)  # probabilities of no indels for each cherry
sum( outcomes * log(pr), (1-outcomes) * log(1-pr) )
}
csvfolder <- list.files(path="~/PycharmProjects/hiv-evolution-master/9_2_indels",full.names=TRUE)
max.llh <- data.frame(stringsAsFactors = FALSE)
max.llh2 <- data.frame(subtype=character(),stringsAsFactors = FALSE)
con.int <- data.frame(stringsAsFactors = FALSE)
big.df <- data.frame(stringsAsFactors = FALSE)
rates <- c()
for (i in 1:length(csvfolder)){
csv <- read.csv(csvfolder[i])
filename <- strsplit(strsplit(csvfolder[i], "/")[[1]][7], "\\+.")[[1]][1]
max.llh2 [i,1] <- filename
print(filename)
times.df <- c()
outcomes.df <- data.frame()
for (z in 1:5){
times <- csv$total.length[which(!is.na(csv[paste0("VR",z,".indel")]))]
times.df <- c(times.df, times)
outcomes <- csv[which(!is.na(csv[paste0("VR",z,".indel")])),paste0("VR",z,".indel")]
outcomes.df <- rbind(outcomes.df, data.frame(out=outcomes, vregion=z))
obj.f <- function(rate) -pll(rate, outcomes, times)  # objective function
mle.result <- bbmle::mle2(obj.f, start=list(rate=1), method = "Brent", lower=1e-12, upper = 1)
max.llh <- rbind(max.llh, data.frame(subtype=filename, vloop=z, rate=coef(mle.result)[[1]]))
max.llh2 [i,z+1] <- coef(mle.result)[[1]]
rates <- c(rates,coef(mle.result)[[1]]) # this is the rate
#res$value #this is the likelihood
if(!all(outcomes)){
int <- confint(mle.result, level = 0.95)
con.int <- rbind(con.int,data.frame(subtype=filename,vloop=z,lower=int[[1]],upper=int[[2]]))
}else{
con.int <- rbind(con.int,data.frame(subtype=filename,vloop=z,lower=0,upper=0))
}
}
big.df <- rbind(big.df, data.frame(subtype=rep(filename, length(times.df)), Time=times.df, outcomes=outcomes.df$out, Vregion=as.factor(outcomes.df$vregion)))
}
#v.order <- c(5,1,2,3,4)
#big.df <- big.df[order(match(big.df$Vregion,v.order)),]
fit <- glm(!outcomes ~ subtype + Vregion + Time, family= "binomial", data=big.df)
fit2 <- glm(!outcomes ~ subtype * Vregion + Time, family= "binomial", data=big.df)
fit.aic <- stepAIC(fit, scope=list(upper=fit2, lower=~1), direction='both', trace=TRUE)
summary(fit.aic)
write.csv(max.llh, "indel_rates2.csv")
write.csv(con.int, "conf_ints2.csv")
